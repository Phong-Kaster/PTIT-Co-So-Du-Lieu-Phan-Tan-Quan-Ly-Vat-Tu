*Mục đích : lấy chi tiết phiếu nhập | xuất do một nhân viên X lập từ ngày Y tới ngày Z với mã nhân viên.

*Cú pháp:

CREATE PROCEDURE sp_HoatDongNhanVien
@MANV int,
@LOAI nvarchar(4),
@FROMYEAR int,
@FROMMONTH int,
@TOYEAR int,
@TOMONTH int
AS
BEGIN
	IF( @LOAI = 'NHAP')
	BEGIN
		SELECT FORMAT(PN.NGAY,'MM-yyyy') AS THANGNAM, -- Group theo mẫu
				PN.NGAY, PN.MAPN AS MAPHIEU,
				TENVT, 
				TENKHO, 
				CTPN.SOLUONG, 
				CTPN.DONGIA, 
				THANHTIEN = SOLUONG * DONGIA
		FROM (SELECT NGAY, 
					MAPN,
					TENKHO = ( SELECT TENKHO FROM Kho WHERE P.MAKHO = Kho.MAKHO )
				FROM PhieuNhap AS P
				WHERE ( YEAR(NGAY) >= @FROMYEAR AND MONTH(NGAY) >= @FROMMONTH )
				AND ( YEAR(NGAY) <= @TOYEAR AND MONTH(NGAY) >= @TOMONTH )
				AND MANV = @MANV )PN,
				CTPN,
				(SELECT MAVT, TENVT FROM Vattu ) VT
		WHERE PN.MAPN =CTPN.MAPN
		AND VT.MAVT = CTPN.MAVT
		ORDER BY THANGNAM, NGAY
	END

	ELSE
	BEGIN
		SELECT FORMAT(PX.NGAY,'MM-yyyy') AS THANGNAM, -- Group theo mẫu
				PX.NGAY, PX.MAPX AS MAPHIEU,
				TENVT, 
				TENKHO, 
				CTPX.SOLUONG, 
				CTPX.DONGIA, 
				THANHTIEN = SOLUONG * DONGIA
		FROM (SELECT NGAY, 
					MAPX,
					TENKHO = ( SELECT TENKHO FROM Kho WHERE P.MAKHO = Kho.MAKHO )
				FROM PhieuXuat AS P
				WHERE ( YEAR(NGAY) >= @FROMYEAR AND MONTH(NGAY) >= @FROMMONTH )
				AND ( YEAR(NGAY) <= @TOYEAR AND MONTH(NGAY) >= @TOMONTH )
				AND MANV = @MANV )PX,
				CTPX,
				(SELECT MAVT, TENVT FROM Vattu ) VT
		WHERE PX.MAPX =CTPX.MAPX
		AND VT.MAVT = CTPX.MAVT
		ORDER BY THANGNAM, NGAY
	END
END

*Chú ý: đây cũng là 1 câu truy vấn viết theo hướng tối ưu thay vì làm bình thường như câu dưới. Tuy nhiên viết kiểu trên là không bắt buộc, các bạn thấy cách làm nào dễ hiểu thì làm theo cách đó

SELECT FORMAT(NGAY,'MMMM yyyy'), PHIEU.MAPN,TENVT,SOLUONG,DONGIA, TENKHO
FROM PhieuNhap AS PHIEU,
	CTPN AS CT,
	Vattu AS VT,
	Kho AS K
WHERE PHIEU.MAPN = CT.MAPN
AND CT.MAVT = VT.MAVT
AND PHIEU.MAKHO = K.MAKHO
AND PHIEU.MANV = 6
AND ( YEAR(NGAY) >= 2020 AND MONTH(NGAY) >= 1 )
AND ( YEAR(NGAY) <= 2021 AND MONTH(NGAY) >= 1 )
ORDER BY THANGNAM, NGAY
*Xem kết quả:
EXEC sp_HoatDongNhanVien 6, 'XUAT', 2009,1,2021,1
EXEC sp_HoatDongNhanVien 6, 'NHAP', 2009,1,2021,1